name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: ${{ matrix.platform }} (py${{ matrix.python-version }})
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest, macos-14]
        python-version: ["3.11"]
        include:
          # macos-14 is ARM64 (Apple Silicon M1)
          - platform: macos-14
            pixi-platform: osx-arm64
          # windows-latest is x64
          - platform: windows-latest
            pixi-platform: win-64

    steps:
      - uses: actions/checkout@v4

      - name: Set up pixi
        uses: prefix-dev/setup-pixi@v0.9.2
        with:
          pixi-version: v0.63.2
          cache: true
          environments: ci

      - name: Install package in development mode
        run: pixi run -e ci pip install -e . --no-deps

      - name: Run tests
        uses: aganders3/headless-gui@v2
        with:
          run: pixi run -e ci pytest -v --color=yes

  # Separate job for Linux with xvfb for headless display
  test-linux:
    name: ubuntu-latest (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up pixi
        uses: prefix-dev/setup-pixi@v0.9.2
        with:
          pixi-version: v0.63.2
          cache: true
          environments: ci

      - name: Install package in development mode
        run: pixi run -e ci pip install -e . --no-deps

      - name: Run tests with xvfb
        uses: aganders3/headless-gui@v2
        with:
          run: pixi run -e ci pytest -v --color=yes
